# Chapter 3
This chapter consists of a detailed view over the inner workings and functional requirements of the platform CASCIFFO.
It is structured with the following sections:
- Technologies & Frameworks: Description of technologies and frameworks used in the development of CASCIFFO. 
- Access control: Identification and categorization of actors and their roles.
- Processes: Identification and detailing of the flow of processes.
- Functional Requirements: Description of functional requirements.


## 1 Technologies
falar de PWA, react, typescript, spring-web, cra (create-react-app), node, choice of npm over yarn, npx

## 2 Access control
Given the nature of the platform CASCIFFO, where many actors are at play, there needs to be a well-defined structure of access control. Each involved actor must have a role and a set of permissions. The actors involved within the application are the UIC, Administrative Council ("Concelho Administrativo", CA), the Financial and Juridical department, UIC Support Office ("Gabinete de apoio à UIC", GAUIC) and finally a Superuser. These actors have been categorized, in the format Role={Actor}, as follows:  
- UIC={UIC, GAUIC} ⇒ baseline of permissions, each user belonging to this role can view any clinical investigation, create, edit and cancel their own Clinical Investigations.
- Finance={Financial department} ⇒ Can validate Clinical Trials financial component.
- Juridical={Juridical department} ⇒ Can validate Clinical Trials juridical component.
- Management={CA} ⇒ Can validate/cancel pending clinical investigation proposals.
- Superuser={} ⇒ Has absolute control over the application.

## 3 Processes
This section details the types of processes occurring within the scope of the project.  
There are two identified processes, which consists of the lifecycle of a clinical investigation proposal and the Clinical Trials.

### 3.1 clinical investigation proposals
From the moment a clinical investigation is proposed, it follows through a series of states and protocols that must be adhered to in order for it to be completely validated.
There are two types of Clinical Investigations: Clinical Trials and Observational Trials.  
Each state has an entity responsible, `owner`, for advancing the state. 
The flow of states is as follows:  
1) `Submetido`, `owner=UIC`
2) `Negociação de CF`, `owner=UIC`
3) `Validação interna`, `owner=Finance,Juridical`
4) `Validação externa`, `owner=UIC`
5) `Submissão ao CA`, `owner=UIC`
6) `Validação interna`, `owner=Management`

The enumerated set of states corresponds to the lifecycle of a Clinical Trial Proposal. An Observational Trial Proposal consists of the enumerated states {1,4,5,6}; it lacks a financial component and a promoter.  

Taking the example of the submission of a Clinical Trial Proposal, an investigator starts by creating and submitting a proposal. Once it's submitted, the CA will be notified, via app and email. This state is described as `Submetido`.  
When the negotiation of the financial contract begins, the principal Investigator (which has the role of UIC), will advance the state to its next step in the proposal's evolution, `Negociação de CF`.  
When the financial negotiation reaches an agreement of the UIC and external promotor, the investigator advances the state to its next stage, `Validação Interna`. Upon advancing, the users with the Role of `Finance` and `Juridical`, which represents the Financial and Juridical internal departments, respectfully, will be notified that a proposal is ready to be evaluated. The evaluation will consist of a simple `Accept` or `Refuse` with added justification for the choice. In case either the user with `Finance` or `Juridical` role reject the financial contract, the proposal's will backtrack to `Negociação de CF`, notifying the UIC of the occurrence.  
When it's accepted by both roles, the proposal will automatically advance into the next state, `Validação Externa`. In this state the UIC verifies all the documents and final version of the financial contract, and sends them, via the platform CASCIFFO, to the external promotor, requesting their signatures. When the reply is received via email, the UIC adds the received signatures and possible additional documents to the proposal in the CASCIFFO platform, advancing it to the next stage `Submissão ao CA`.  
The state `Submissão ao CA` will notify the principal investigator both via the platform and email that a proposal requires their signature. Once the principal investigator submits their signature into the platform, UIC(investigator? another person within the UIC?) will verify the documents and (carta EC?) advance the state into `Validação interna`, where the `CA` role will receive a notification stating that a proposal is ready for its final evaluation.  
Once a user with the role of `CA` checks the proposal it can validate or invalidate the proposal. In case it's invalidated, the proposal will become `cancelled` with its lifecycle ending there, however, if it is validated, the proposal can become fully validated once the termination of another process is completed successfully.  
This process, which can be considered a sub-process, called the [validation] protocol, starts in a parallel manner when the proposal is first submitted.  
The purpose of this protocol is to validate the clinical investigation's ethical and safety values.  
When a proposal is submitted, this protocol begins in a manner that is parallel to the mentioned flow of states.  It is then simultaneously sent to internal and external agencies for review and approval, the [Clinical Investigations Ethics Comity ("Comissão de Ética para Investigação Clínica", CEIC)](https://www.ceic.pt/) and [INFARMED, I.P](https://www.infarmed.pt/web/infarmed) respectfully.
Once it has successfully passed through the described validation protocol, a Clinical or Observational Trial is automatically created, importing the core information from the proposal.  
If either process declares the proposal invalid, its state becomes `cancelled`, notifying the UIC and showing the root cause of cancelation.

Each proposal is distinguished by six main properties, the principal investigator, the type of investigation, the type of therapeutic service it's integrated into (i.e Oncology), the `Sigla` which represents the name of the therapeutic or medicine, the partnerships involved in the investigation and the medical team participating in the investigation.  
Proposals with a financial component must also include the promoter of the investigation, in addition to the properties listed.  

### 3.2 Clinical Trials
The lifecycle of a Clinical Trial is divided into three stages: active, completed, and canceled.  
During the active stage, the principal investigator of the Clinical Trial will monitor, schedule appointments and manage the patients involved in the study.  
A Clinical Trial includes a financial component displaying the total budget, balance and payment values for the costs that can be viewed. This component is updated by a user with `Finance` role.



## 4 Functional Requirements
This section details the functional requirements and presents a mock user interface (UI) that will satisfy the requirement.
The main features of CASCIFFO can be separated into 3 groups, which are: general functionalities, clinical component and financial component.  
1) General features  
   - Visualization and management of Clinical Trials as a process; 
   - Ability to edit and validate data (edit checks);
   - Access control based on different user profiles; 
   - Access by computer, tablet or smartphone; 
   - Ability to export information in numerical or graphical mode; 
   - Ability to customize the form of visualization.
2) Clinical Component
   - View detailed characteristics and evolution of clinical Trials including the tested medicine or technique in question;
   - Monitoring the set of patients included in clinical Trials and their characteristics;
   - Insertion of patient data in face-to-face or teleconsultation;
   - Inclusion of Supplementary Diagnostic Therapy (MCDT) associated with (ECG, RX, etc.);
   - Characteristics of the treatment associated with the clinical trial and monitoring of the patient’s behavior under trial and its attendance;
   - Pharmacy monitoring (Reception, dispensing, return, stock);
   - Monitoring of visits;
   - Recording of adverse events associated with patients due to the trial drug.  

## 4.1 General Features
In this section, the general features mentioned in the document will be described and illustrated through mock-ups.

### 4.1.1 Visualization and management of Clinical Trials as a process
To view and manage a Clinical Trial as a process, a user needs only to view the general overview of Clinical Trials or Clinical Investigations Proposals.
As shown in fig.N and fig.N, the user has an overview of the all submitted proposals and clinical trials with their main characteristics, such as, the identification, current state, last alteration date, the principal investigator and whether it has partnerships or not.

![Fig.N](images/proposals.png)

![Fig.N](images/ensaios.png)


When a user clicks in view details ("ver detalhe"), he will be redirected to a screen displaying the details of the target clinical investigation.

### 4.1.2 Ability to edit and validate data (edit checks)
Within the CASCIFFO platform, the UIC and internal departments can view the details of a certain clinical investigation proposal and edit or validate according to their roles.
Users with `UIC` role will be able to edit their own Investigations, whereas the internal departments, with roles of `CA`, `Finance` and `Juridical` will be able to validate within their own responsibilities.  
The figure below, fig.N illustrates the UI displayed to a user with role `UIC` editing one of their investigations.

PLACE FIGURE HERE

The data fields corresponding to the therapeutic area, the service and the pathology of an investigation are restricted to a set of possible inputs. In addition, the members of a medical team also belong to an already defined database, [being validated at the time of creation of the medical team for the investigation.] REVIEW

### 4.1.3 Access control based on different user profiles
The access control within the CASCIFFO application is based on roles.
As described in section 1, there are defined roles for each type of user.  
A user with the role `UIC` can manage their own clinical investigation, being able to edit and have a hand in advancing the state. In addition, it also has an overview over all ongoing investigations, not being able to edit those that weren't created by said user. Once this user logs in, a dashboard showing overall statistics of the platform, i.e. number of active clinical trials, number of submitted proposals, etc.
The role `Financial` is responsible for validating and updating the financial components of the investigations, thus when a user with this role logs in, an appropriate financial management screen will be displayed, whereas the `Juridical` component validates the juridical component.  
The role `CA` is responsible for giving the final say in whether an investigation proposal can have the go-ahead to begin their clinical trials or observations.  
A user of role `CA` once logged in, will be shown a primary screen displaying the overview of clinical investigation proposals awaiting validation.
Finally, we have the `Superuser` role, which has the ability to execute every mentioned action.


### 4.1.4 Access by computer, tablet or smartphone
CASCIFFO is a web-application, however, by utilizing the Progressive Web Application (PWA) framework, it can be installed and used as an application, on any device with browsers that support service workers. This feature is supported by the latest version of any browser, barring Internet Explorer which does not have any support for service workers.  
Among the features a PWA allows, the framework was chosen by its ability to let an application run in offline-mode and versatility in that it can be installed via the browser, as shown in fig.N, and used like a standalone app. 

![FIGURE HERE TO ILLUSTRATE INSTALL APP FROM BROWSER]()

### 4.1.5 Ability to export information in numerical or graphical mode
CASCIFFO offers the ability to export information via excel, and visualize graphic data within the app.  
There is a feature, shown in fig.N that allows a user to export data, e.g a selected number of clinical investigation proposals. This feature is present in the screens showing listed data, e.g list of clinical investigation proposals, and the details of each clinical investigation, proposal or trial.

![FIGURE HERE TO ILLUSTRATE EXPORT TO EXCEL FEATURE]()

### 4.1.6 Ability to customize the form of visualization
**TO BE DONE**

### 4.2.1 View detailed Characteristics and evolution of clinical Trials including the tested medicine or technique in question

To view detailed information about a clinical investigation, one needs to first overview the Clinical Investigations and click on the details of a desired clinical investigation.
The evolution of any clinical investigation consists of its proposal followed the trial activity once the proposal has been fully validated.
In fig.N, the details of a Clinical Trial proposal can be viewed. The flow of state of a proposal is shown in the form of a bar in a straight forward manner. Each state corresponds to a division, box, in the bar and has three properties: the name of the State, the date it was completed (if it hasn't been completed it will be shown as "------") and finally the entity responsible for advancing the state.  
It is possible to click in the box of a state to display information about the events that occurred during the time the proposal was in that state. 

![Fig.N](images/proposta-detalhe.png) **UPDATE WITH MEDICAL TEAM LIST**


A Clinical Trial proposal also another four components alongside its principal details displayed as tabs: the Contacts ("Contactos") which corresponds to comments related to external communications, viewed in fig.N; the Observations ("Observações") which contains comments made in regard to the proposal, viewed in fig.N; the Partnerships ("Parcerias"), where one can find the partnerships involved in the study proposal, viewed in fig.N; and finally the validation Protocol ("Protocolo"), where it can be viewed the current state of affairs of the process described in section 3.1, viewed in fig.N. In all tabs except the one pertaining to the Protocol validation, the state of the proposal will be shown.

![FIGURE CONTACTS]()
![FIGURE OBSERVATIONS]()
![FIGURE PARTNERSHIPS]()
![FIGURE PROTOCOL]()

### 4.2.2 Monitoring the set of patients included in clinical Trials and their characteristics

The details of the set of patients involved in a clinical trial will be displayed when viewing the details of said clinical trial, under the tab "Pacientes". In this screen, shown in fig.N, there are three tabs dedicated to the monitoring of patients, which are named: "Visitas", "Consultas" and "Pacientes". These tabs are exaplained below.

![FIGURE SHOWING CLINICAL TRIAL DETAILS ]()



#### A. Visitas
This tab displays information regarding visits made to accompany patients during the trials.  
The principal investigator can 

#### B. Consultas
The tab "Consultas" contains information regarding medical appointments of the patients.
?

#### C. Pacientes
This tab shows the set of patients involved in the study, being possible to click on a patient and view his details, such as the history of medical appointments for only this patient.

### 4.2.3 Insertion of patient data in face-to-face or teleconsultation
TBD


### 4.2.4 Inclusion of Supplementary Diagnostic Therapy (MCDT) associated with (ECG, RX, etc.)
TBD


### 4.2.5 Characteristics of the treatment associated with the clinical trial and monitoring of the patient’s behavior under trial and its attendance
The characteristics of the treatment associated with clinical trials consists of 3 factors, the service field it's in, the therapeutic area and the pathologies the clinical trial aims to investigate/treat. These details can be found in the detailed view of a clinical trial.  
The monitoring of the patient's behavior and its attendance, as mentioned in section 4.2.2, can also be viewed in the detailed screen of a clinical trial, under the respective tabs.


### 4.2.6 Pharmacy monitoring (Reception, dispensing, return, stock) -- TO BE REMOVED; REPLACED WITH THE MONITORING OF ARCHIVES (DOSSIERS)



### 4.2.7 Monitoring of visits
TBD tem haver com atividades de visitas


### 4.2.8 Recording of adverse events associated with patients due to the trial drug.  
TBD tem haver com o registo de eventos adversos nas atividades de visita